---
- name: Check if image suffix is provided
  fail:
    msg: "os_images_name_suffix is empty please provide it."
  when: os_images_name_suffix is defined and os_images_name_suffix | length == 0

- name: Ensure images for retirement exist
  os_image:
    auth_type: "{{ os_images_auth_type }}"
    auth: "{{ os_images_auth }}"
    cacert: "{{ os_images_cacert | default(omit) }}"
    interface: "{{ os_images_interface | default(omit, true) }}"
    name: "{{ item.name[:-(os_images_name_suffix | length | int)] }}"
    state: present
  loop: "{{ os_images_list }}"
  when: "item.rename_image | default(os_images_promote) | bool"

- name: Ensure images for promotion exist
  os_image:
    auth_type: "{{ os_images_auth_type }}"
    auth: "{{ os_images_auth }}"
    cacert: "{{ os_images_cacert | default(omit) }}"
    interface: "{{ os_images_interface | default(omit, true) }}"
    name: "{{ item.name }}"
    state: present
  loop: "{{ os_images_list }}"
  when: "item.rename_image | default(os_images_promote) | bool"

- name: Ensure old images are retired
  command: "{{ os_images_venv }}/bin/openstack image set {{ promotion_name }} --name {{ promotion_name }}.{{ date_suffix }}"
  vars:
    date_suffix: "{{ ansible_date_time.date }}"
    promotion_name: "{{ item.name[:-(os_images_name_suffix | length | int)] }}"
  loop: "{{ os_images_list }}"
  when: "item.rename_image | default(os_images_promote) | bool"
  environment: "{{ os_images_venv }}"

- name: Ensure new images are promoted
  command: "{{ os_images_venv }}/bin/openstack image set {{ item.name }} --name {{ promotion_name }}"
  vars:
    promotion_name: "{{ item.name[:-(os_images_name_suffix | length | int)] }}"
  loop: "{{ os_images_list }}"
  when: "item.rename_image | default(os_images_promote) | bool"
  environment: "{{ os_images_venv }}"
